import React, { useState, useEffect, useCallback } from 'react';
import { Loader, AlertCircle, SearchX, Play, ExternalLink } from 'lucide-react';

const customStyles = `
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');

  body {
      font-family: 'Outfit', sans-serif;
      background-color: #0f1014; /* Slightly bluer dark background */
      color: #e0f2fe; /* Pale blue text */
      overflow-x: hidden;
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar {
      width: 8px;
  }
  ::-webkit-scrollbar-track {
      background: #161b22; 
  }
  ::-webkit-scrollbar-thumb {
      background: #7dd3fc; /* Pale Blue (Sky-300) */
      border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
      background: #38bdf8; /* Sky-400 */
  }

  .glass-panel {
      background: rgba(14, 28, 45, 0.7); /* Dark blue tint */
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(125, 211, 252, 0.1);
  }

  .truncate-2-lines {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
  }
`;

// --- Main App Component ---

export default function App() {
    // ---------------------------------------------------------
    // Configuration
    // ---------------------------------------------------------
    const API_KEY = "AIzaSyCT5lEJ6uIaN4kpi9nIf6lmoyyx0-XT4hI"; 
    const PLAYLIST_ID = "PLUFFl4hYd1R0hXxp-G6qU9IjaT0uAFSIN";
    
    // State
    const [videos, setVideos] = useState([]);
    const [channelInfo, setChannelInfo] = useState(null);
    
    // UI State
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // Helper to fetch channel info
    const fetchChannelInfo = async (chId) => {
        try {
            const channelUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${chId}&key=${API_KEY}`;
            const channelRes = await fetch(channelUrl);
            const channelData = await channelRes.json();

            if (channelData.items && channelData.items.length > 0) {
                const info = channelData.items[0];
                setChannelInfo({
                    title: info.snippet.title,
                    avatar: info.snippet.thumbnails.high.url,
                });
            }
        } catch (err) {
            console.error("Error fetching channel info", err);
        }
    };

    // Main fetch function
    const fetchData = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
            // 1. Fetch Playlist Items
            const vidUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${PLAYLIST_ID}&maxResults=50&key=${API_KEY}`;
            const vidRes = await fetch(vidUrl);
            const vidData = await vidRes.json();

            if (vidData.error) {
                throw new Error(vidData.error.message);
            }

            if (!vidData.items || vidData.items.length === 0) {
                setVideos([]);
                setLoading(false);
                return;
            }

            // Normalize and set videos
            const normalizedVideos = vidData.items.map(item => ({
                ...item,
                id: item.snippet.resourceId.videoId, // Normalize ID
                snippet: item.snippet
            }));

            setVideos(normalizedVideos);

            // 2. Fetch Channel Info (using channelId from the first video)
            if (normalizedVideos.length > 0) {
                const derivedChannelId = normalizedVideos[0].snippet.channelId;
                await fetchChannelInfo(derivedChannelId);
            }

        } catch (err) {
            console.error("Error fetching data", err);
            setError(`Failed to load playlist: ${err.message}`);
        } finally {
            setLoading(false);
        }
    }, []); 

    // Effect to trigger fetch on mount
    useEffect(() => {
        fetchData();
    }, [fetchData]);

    const openVideo = (videoId) => {
        window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
    };

    return (
        <div className="min-h-screen pb-10 relative bg-[#0f1014] text-slate-100 font-[Outfit]">
            <style>{customStyles}</style>
            
            {/* Background Elements (Pale Blue Theme) */}
            <div className="fixed top-0 left-0 w-full h-full pointer-events-none z-0 overflow-hidden">
                <div className="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-sky-600/20 rounded-full blur-[120px]"></div>
                <div className="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-cyan-600/20 rounded-full blur-[120px]"></div>
            </div>

            {/* Navbar */}
            <nav className="relative z-20 flex justify-between items-center p-6 px-4 md:px-10 max-w-7xl mx-auto">
                <div className="flex items-center gap-4">
                    <div className="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center p-2 border border-sky-500/30 shadow-lg shadow-sky-500/20">
                         <img 
                            src="https://static.wikitide.net/bandoriwiki/0/0c/Band_45.svg" 
                            alt="MyGO!!!!!" 
                            className="w-full h-full object-contain"
                        />
                    </div>
                    <h1 className="text-3xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-sky-300 to-cyan-200">
                        MyGO!!!!! playlist
                    </h1>
                </div>
            </nav>

            {/* Main Content Area */}
            <main className="relative z-10 max-w-7xl mx-auto px-4 md:px-10 mt-8">
                
                {/* Playlist Grid Section */}
                <section className="w-full pb-10">
                    <div className="flex items-center gap-4 mb-8 border-b border-sky-500/20 pb-4">
                        {channelInfo ? (
                            <>
                                <img src={channelInfo.avatar} alt="Channel" className="w-10 h-10 rounded-full border border-sky-400" />
                                <div>
                                    <h3 className="font-bold text-lg text-sky-100">{channelInfo.title}</h3>
                                    <p className="text-xs text-sky-400/80">Stream Library</p>
                                </div>
                            </>
                        ) : (
                            <div className="flex items-center gap-4">
                                <div className="w-10 h-10 rounded-full bg-white/10 animate-pulse"></div>
                                <div>
                                    <div className="h-5 w-32 bg-white/10 rounded animate-pulse mb-1"></div>
                                    <p className="text-xs text-gray-400">Loading channel info...</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {loading && (
                        <div className="flex flex-col items-center justify-center py-20 text-sky-200/50">
                            <Loader className="animate-spin mb-4" size={32} />
                            <p>Loading playlist...</p>
                        </div>
                    )}
                    
                    {error && (
                        <div className="p-6 bg-red-500/10 border border-red-500/20 rounded-xl text-red-200 text-center">
                            <AlertCircle size={32} className="mx-auto mb-2" />
                            <p className="font-bold">Error</p>
                            <p className="mb-4">{error}</p>
                        </div>
                    )}

                    {!loading && !error && videos.length === 0 && (
                        <div className="flex flex-col items-center justify-center h-48 text-gray-500 text-center p-4 border border-white/5 rounded-xl bg-white/5">
                            <SearchX size={32} className="mb-2 opacity-50" />
                            <p className="font-medium text-gray-300">No videos found</p>
                        </div>
                    )}

                    {/* GRID LAYOUT FOR TILES */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        {!loading && videos.map((video) => {
                            const thumbnailUrl = video.snippet.thumbnails.high?.url || video.snippet.thumbnails.medium?.url || video.snippet.thumbnails.default?.url;

                            return (
                                <div 
                                    key={video.id}
                                    onClick={() => openVideo(video.id)}
                                    className={`
                                        group relative rounded-xl overflow-hidden cursor-pointer transition-all duration-300
                                        hover:-translate-y-2 hover:shadow-2xl hover:shadow-sky-500/20
                                        bg-[#161b22] border border-sky-500/10 hover:border-sky-400/50
                                    `}
                                >
                                    {/* Tile Image */}
                                    <div className="relative aspect-video w-full overflow-hidden">
                                        <img 
                                            src={thumbnailUrl} 
                                            className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                            alt={video.snippet.title}
                                        />
                                        <div className="absolute inset-0 bg-black/20 group-hover:bg-black/30 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100">
                                            <div className="w-14 h-14 rounded-full bg-sky-500/90 backdrop-blur-md flex items-center justify-center shadow-lg transform scale-75 group-hover:scale-100 transition-all duration-300">
                                                <ExternalLink className="text-white" size={24} />
                                            </div>
                                        </div>
                                        {/* Duration badge or overlay could go here */}
                                    </div>
                                    
                                    {/* Tile Details */}
                                    <div className="p-4">
                                        <h4 className="font-semibold leading-tight truncate-2-lines mb-2 text-sky-100 group-hover:text-sky-300 transition-colors">
                                            {video.snippet.title}
                                        </h4>
                                        <div className="flex justify-between items-center text-xs text-slate-400">
                                            <span>{new Date(video.snippet.publishedAt).toLocaleDateString()}</span>
                                            <span className="bg-sky-900/30 text-sky-300 px-2 py-1 rounded border border-sky-500/20">YouTube</span>
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </section>
            </main>
        </div>
    );
}
